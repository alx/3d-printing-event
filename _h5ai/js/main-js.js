/*jslint browser: true, confusion: true, regexp: true, white: true */
(function(a){"use strict";var b={};(function(a,b){b.util=function(){var b=/^\/([^\/]+\/?)$/,c=/^(\/(?:.*\/)*?([^\/]+)\/)([^\/]+\/?)$/,d=function(a){var d;if(a==="/")return{parent:null,parentname:null,name:"/"};d=c.exec(a);if(d)return{parent:d[1],parentname:d[2],name:d[3]};d=b.exec(a);if(d)return{parent:"/",parentname:"/",name:d[1]}},e=/\/$/,f=function(a){return e.test(a)},g=function(b,c){var d,e,g;return f(b)||(b+="/"),c?(d=a(c).find("td").eq(1).find("a"),e=d.text()==="Parent Directory",g=d.attr("href"),e?undefined:b+g):b},h=1e3,i=/^\s*([\.\d]+)\s*([kmg]?)b?\s*$/i,j=function(a){var b=i.exec(a),c,d;return b?(c=parseFloat(b[1]),d=b[2].toLowerCase(),d==="k"?c*=h:d==="m"?c*=h*h:d==="g"?c*=h*h*h:d==="t"&&(c*=h*h*h*h),c):-1},k=["B","KB","MB","GB","TB"],l=function(a){var b=1e3,c=0,d=k.length-1;if(isNaN(a))return a;while(a>=b&&c<d)a/=h,c+=1;return(c<=1?Math.round(a):a.toFixed(1)).toString()+" "+k[c]},m=function(a){try{return decodeURI(a)}catch(b){}return a};return{splitPath:d,pathEndsWithSlash:f,getAbsHref:g,parseSize:j,formatSize:l,checkedDecodeUri:m}}()})(jQuery,b),function(a,b,c,d){c.core=function(){var e=b(a),f={store:{viewmode:"h5ai.pref.viewmode",lang:"h5ai.pref.lang"},callbacks:{pathClick:[]},rootAbsHref:"/",h5aiAbsHref:"/_h5ai/",customHeader:"_h5ai.header.html",customFooter:"_h5ai.footer.html",viewmodes:["details","icons"],sortorder:"na",showTree:!0,slideTree:!0,folderStatus:{},lang:null,useBrowserLang:!0,setParentFolderLabels:!0,linkHoverStates:!0,dateFormat:"yyyy-MM-dd HH:mm",showThumbs:!1,zippedDownload:!1},g=b.extend({},f,d.options),h=g.dateFormat,i=function(a){var c={};return b.each(a,function(a,d){b.each(d,function(b,d){c[d]=a})}),c}(d.types),j=function(){return g.h5aiAbsHref+"php/api.php"},k=function(a){return g.h5aiAbsHref+"images/"+a+".png"},l=function(a,b){return g.h5aiAbsHref+"icons/"+(b?"48x48":"16x16")+"/"+a+".png"},m=function(a){var c=b("#viewdetails"),d=b("#viewicons"),e=b("#extended");a?amplify.store(g.store.viewmode,a):a=amplify.store(g.store.viewmode),a=b.inArray(a,g.viewmodes)>=0?a:g.viewmodes[0],c.add(d).removeClass("current"),a==="details"?(c.addClass("current"),e.addClass("details-view").removeClass("icons-view").show()):a==="icons"?(d.addClass("current"),e.removeClass("details-view").addClass("icons-view").show()):e.hide()},n=function(){var a=b("body"),c=b("#tree"),d=function(){var d=e.height(),f=b("body > nav").outerHeight(),g=b("body > footer").outerHeight(),h=50,i=30;a.css({"margin-top":f+h,"margin-bottom":g+h}),c.css({top:f+i,height:d-f-g-18-2*i});try{c.get(0).updateScrollbar()}catch(j){}};e.resize(function(){d()}),d()},o=function(){var a=b("#navbar"),c=b("#extended");b("#table").remove(),g.viewmodes.length>1&&(b.inArray("icons",g.viewmodes)>=0&&b("<li id='viewicons' class='view'><a href='#'><img alt='view-icons' /><span class='l10n-icons'>icons</span></a></li>").find("img").attr("src",k("view-icons")).end().click(function(){m("icons")}).appendTo(a),b.inArray("details",g.viewmodes)>=0&&b("<li id='viewdetails' class='view'><a href='#'><img alt='view-details' /><span class='l10n-details'>details</span></a></li>").find("img").attr("src",k("view-details")).end().click(function(){m("details")}).appendTo(a)),c.find(".entry a").hover(function(){if(c.hasClass("icons-view")){var a=b(this);b(".status.default").hide(),b(".status.dynamic").empty().append(a.find(".label").clone()).append(b("<span class='sep'>路</span>")).append(a.find(".date").clone()).show(),a.closest(".entry").hasClass("folder")||b(".status.dynamic").append(b("<span class='sep'>路</span>")).append(a.find(".size").clone())}},function(){b(".status.default").show(),b(".status.dynamic").empty().hide()})},p=function(a,c){var d=b("#tree"),e=b("#extended");g.slideTree&&d.outerWidth()<e.offset().left||a?c?d.stop().css({left:0}):d.stop().animate({left:0}):c?d.stop().css({left:18-d.outerWidth()}):d.stop().animate({left:18-d.outerWidth()})},q=function(){b("#tree").hover(function(){p(!0)},function(){p()}),e.resize(function(){p()}),p(!1,!0)},r=function(a){var c=[];return b("a[href^='/']").each(function(){b(this).attr("href")===a&&c.push(this)}),b(c)},s=function(){g.linkHoverStates&&b("a[href^='/']:not(.linkedHoverStates)").each(function(){var a=b(this).addClass("linkedHoverStates"),c=a.attr("href");a.hover(function(){r(c).addClass("hover")},function(){r(c).removeClass("hover")})})},t=function(a){a&&(h=a),b("#extended .entry .date").each(function(){var a=b(this),c=a.data("time"),d=c?(new Date(c)).toString(h):"";a.text(d)})},u=function(a,c,d){var e=amplify.store(g.store.lang),f,h,i;a[e]?c=e:d&&(f=navigator.language,a[f]?c=f:f.length>2&&a[f.substr(0,2)]&&(c=f.substr(0,2))),a[c]||(c="en"),h=a[c],h&&(b.each(h,function(a,c){b(".l10n-"+a).text(c)}),b(".lang").text(c),b(".langOption").removeClass("current"),b(".langOption."+c).addClass("current")),t(h.dateFormat||g.dateFormat)},v=function(a){var c=b("#langSelector .langOptions"),d=[],e;b.each(a,function(a){d.push(a)}),d.sort(),e=b("<ul />"),b.each(d,function(c,d){b("<li class='langOption' />").addClass(d).text(d+" - "+a[d].lang).appendTo(e).click(function(){amplify.store(g.store.lang,d),u(a,d,!1)})}),c.append(e).scrollpanel(),b("#langSelector").hover(function(){c.css("top","-"+c.outerHeight()+"px").stop(!0,!0).fadeIn(),c.get(0).updateScrollbar()},function(){c.stop(!0,!0).fadeOut()})},w=function(a){var c=b(this),d=c.closest(".entry"),e=b("#tree").get(0).updateScrollbar;c.hasClass("unknown")?b.get(j(),{action:"tree",href:d.find("> a").attr("href")},function(a){var f=b(a);c.removeClass("unknown"),f.find("> li").size()===0?c.replaceWith(b("<span class='blank' />")):(c.addClass("open"),d.find("> .content").replaceWith(f),e(),f.find(".indicator:not(.initiated)").click(w).addClass("initiated"))}):c.hasClass("open")?(c.removeClass("open"),e(!0),d.find("> .content").slideUp(function(){e()})):(c.addClass("open"),e(!0),d.find("> .content").slideDown(function(){e()}))},x=function(){b("#tree .entry.folder .indicator:not(.initiated)").click(w).addClass("initiated")},y=function(a){var b=a.lastIndexOf("."),c=b>=0?a.substr(b):a;return i[c.toLowerCase()]||"unknown"},z=function(){b("#extended .entry .size").each(function(){var a=b(this),d=a.data("bytes"),e=d>=0?c.util.formatSize(d):"";a.text(e)})},A=function(){var a=b("#extended");b(".folderTotal").text(a.find(".entry.folder:not(.folder-parent)").length),b(".fileTotal").text(a.find(".entry.file").length)},B=function(){o(),m(),n(),q(),s(),v(d.langs),u(d.langs,g.lang,g.useBrowserLang),z(),A(),x()};return{settings:g,api:j,image:k,icon:l,shiftTree:p,linkHoverStates:s,initIndicators:x,formatDates:t,getFileType:y,init:B}}()}(window,jQuery,b,H5AI_CONFIG),function(a,b){b.sort=function(){var c=function(b){var c=a(b);return c.hasClass("folder-parent")?0:c.hasClass("folder")?1:2},d=function(a,b,d,e){var f,g,h;return f=c(a)-c(b),f!==0?f:(g=e(a),h=e(b),g<h?d?1:-1:g>h?d?-1:1:0)},e=function(b,c){return d(b,c,!1,function(b){return a(b).find(".label").text().toLowerCase()})},f=function(b,c){return d(b,c,!1,function(b){return a(b).find(".date").data("time")})},g=function(b,c){return d(b,c,!1,function(b){return a(b).find(".size").data("bytes")})},h=function(b,c){return d(b,c,!0,function(b){return a(b).find(".label").text().toLowerCase()})},i=function(b,c){return d(b,c,!0,function(b){return a(b).find(".date").data("time")})},j=function(b,c){return d(b,c,!0,function(b){return a(b).find(".size").data("bytes")})},k=function(b){a("#extended .entry").detach().sort(b).appendTo(a("#extended > ul"))},l,m,n=function(a){var b=m[a];l.removeClass("ascending").removeClass("descending"),b.head.addClass(b.clas).attr("href","#!/sort="+a),k(b.fn)},o=function(){var c=a("<img src='"+b.core.image("ascending")+"' class='sort ascending' alt='ascending' />"),d=a("<img src='"+b.core.image("descending")+"' class='sort descending' alt='descending' />"),k=/^.*#!.*\/sort=(.*?)(?:\/.*)?$/.exec(document.location),o=a("#extended li.header"),p=o.find("a.label"),q=o.find("a.date"),r=o.find("a.size");l=o.find("a.label,a.date,a.size"),m={na:{head:p,clas:"ascending",fn:e},nd:{head:p,clas:"descending",fn:h},da:{head:q,clas:"ascending",fn:f},dd:{head:q,clas:"descending",fn:i},sa:{head:r,clas:"ascending",fn:g},sd:{head:r,clas:"descending",fn:j}},n(k?k[1]:b.core.settings.sortorder),p.attr("href","#!/sort=na").append(c.clone()).append(d.clone()).click(function(){n("n"+(p.hasClass("ascending")?"d":"a"))}),q.attr("href","#!/sort=da").prepend(c.clone()).prepend(d.clone()).click(function(){n("d"+(q.hasClass("ascending")?"d":"a"))}),r.attr("href","#!/sort=sa").prepend(c.clone()).prepend(d.clone()).click(function(){n("s"+(r.hasClass("ascending")?"d":"a"))})};return{init:o}}()}(jQuery,b),function(a,b){b.zippedDownload=function(){var c=0,d=0,e=a(document),f=a("#selection-rect"),g=function(){var c=a("#extended a.selected"),d=a("#download"),e,f;c.size()>0?(c.each(function(){f=a(this).attr("href"),e=e?e+":"+f:f}),e=b.core.api()+"?action=zip&hrefs="+e,d.show().find("a").attr("href",e)):d.hide().find("a").attr("href","#")},h=function(b){var e=Math.min(c,b.pageX),g=Math.min(d,b.pageY),h=Math.abs(c-b.pageX),i=Math.abs(d-b.pageY),j;b.preventDefault(),f.css({left:e,top:g,width:h,height:i}),j=f.fracs("rect"),a("#extended a").removeClass("selecting").each(function(){var b=a(this),c=b.fracs("rect"),d=j.intersection(c);d&&!b.closest(".entry").hasClass("folder-parent")&&b.addClass("selecting")})},i=function(b){b.preventDefault(),e.off("mousemove",h),f.hide().css({left:0,top:0,width:0,height:0}),a("#extended a.selecting.selected").removeClass("selecting").removeClass("selected"),a("#extended a.selecting").removeClass("selecting").addClass("selected"),g()},j=function(b){var j=a.fracs.viewport();c=b.pageX,d=b.pageY;if(b.button!==0||c>=j.right||d>=j.bottom)return;b.preventDefault(),b.ctrlKey||(a("#extended a").removeClass("selected"),g()),f.show().css({left:c,top:d,width:0,height:0}),h(b),e.on("mousemove",h).one("mouseup",i)},k=function(a){return a.stopPropagation(),!1},l=function(a){a.ctrlKey||k(a)},m=function(){b.core.settings.zippedDownload&&(a("<li id='download'><a href='#'><img alt='download' /><span class='l10n-download'>download</span></a></li>").find("img").attr("src",b.core.image("download")).end().appendTo(a("#navbar")),a("body>nav,body>footer,#tree").on("mousedown",k),a("#extended").on("mousedown","a",l),e.on("mousedown",j))};return{init:m}}()}(jQuery,b),function(a,b,c){c.Path=function(d,e){var f={},g,h,i,j,k;return f.status=undefined,f.content=undefined,f.html={$crumb:undefined,$extended:undefined,$tree:undefined},f.treeOpen=!1,c.util.pathEndsWithSlash(d)||(d+="/"),e?(g=b(e).find("td"),h=g.eq(1).find("a"),i=Date.parse(g.eq(2).text()),j=c.util.parseSize(g.eq(3).text()),f.parentFolder=d,f.label=h.text(),f.type=g.eq(0).find("img").attr("alt")==="[DIR]"?"folder":c.core.getFileType(f.label),f.href=h.attr("href"),f.time=i?i.getTime():0,f.size=j):(k=c.util.splitPath(d),f.parentFolder=k.parent||"",f.label=c.util.checkedDecodeUri(k.name),f.label==="/"&&(f.label=c.util.checkedDecodeUri(a.domain)),f.type="folder",f.href=k.name,f.time=0,f.size=-1),c.util.pathEndsWithSlash(f.label)&&(f.label=f.label.slice(0,-1)),f.isFolder=f.type==="folder",f.isParentFolder=f.label==="Parent Directory",f.isParentFolder&&(f.isFolder=!0,f.type="folder-parent"),f.absHref=f.isParentFolder?f.href:f.parentFolder+f.href,f.isCurrentFolder=f.absHref===a.location.pathname,f.isDomain=f.absHref==="/",f.isParentFolder&&c.core.settings.setParentFolderLabels&&(f.isDomain?f.label=c.util.checkedDecodeUri(a.domain):(k=c.util.splitPath(f.parentFolder),f.label=c.util.checkedDecodeUri(k.parentname))),f.isEmpty=function(){return!f.content||b.isEmptyObject(f.content)},f.onClick=function(a){c.core.triggerPathClick(f,a)},f}}(document,jQuery,b),function(a,b){b.connector=function(){var c={},d={},e=/^text\/html;h5ai=/,f=function(a,d){var e=b.util.getAbsHref(a,d),f=c[e];return f||(f=b.Path(a,d),f.isParentFolder||(c[f.absHref]=f)),f},g=function(c,f){if(b.core.settings.folderStatus[c]){f(b.core.settings.folderStatus[c]);return}if(d[c]){f(d[c]);return}a.ajax({url:c,type:"HEAD",complete:function(a){var b=a.status;b===200&&e.test(a.getResponseHeader("Content-Type"))&&(b="h5ai"),d[c]=b,f(b)}})},h=function(a){a.isFolder&&!a.isParentFolder&&a.status===undefined&&g(a.absHref,function(c){c!=="h5ai"&&(a.status=c),b.html.updateHtml(a),b.core.linkHoverStates()})},i=function(){a.each(c,function(a,b){h(b)})},j=function(b,c,d){g(b,function(g){if(g!=="h5ai"){d(g,{});return}a.ajax({url:b,type:"GET",dataType:"html",error:function(a){d(a.status,{})},success:function(g,i,j){var k={};if(!e.test(j.getResponseHeader("Content-Type"))){d(j.status,{});return}a(g).find("#table td").closest("tr").each(function(){var a=f(b,this);a.isFolder&&(!a.isParentFolder||c)&&(k[a.absHref]=a,h(a))}),d("h5ai",k)}})})};return{getPath:f,updatePaths:i,fetchStatusAndContent:j}}()}(jQuery,b),function(a,b){b.html=function(){var c=["bmp","gif","ico","image","jpg","png","tiff"],d=function(a,b){},e=function(c){var e,f;return c.html.$crumb&&c.html.$crumb.data("status")===c.status?c.html.$crumb:(e=a("<li class='crumb'><a><img alt='>' /><span></span></a></li>").addClass(c.isFolder?"folder":"file"),c.status&&e.data("status",c.status),f=e.find("a").attr("href",c.absHref).click(function(){d(c,"crumb")}).find("img").attr("src",b.core.image("crumb")).end().find("span").text(c.label).end(),c.isDomain&&(e.addClass("domain"),f.find("img").attr("src",b.core.image("home"))),c.isCurrentFolder&&e.addClass("current"),isNaN(c.status)||(c.status===200?f.append(a("<img class='hint' src='"+b.core.image("page")+"' alt='not listable' />")):f.append(a("<span class='hint'>("+c.status+")</span>"))),c.html.$crumb&&c.html.$crumb.replaceWith(e),c.html.$crumb=e,e)},f=function(e){var f,g,h,i=e.date?e.date.toString(b.core.settings.dateFormat):"",j="",k=b.core.icon(e.type),l=b.core.icon(e.type,!0);return e.html.$extended&&e.html.$extended.data("status")===e.status?e.html.$extended:(f=a("<li class='entry' />").data("path",e).addClass(e.isFolder?"folder":"file"),e.status&&f.data("status",e.status),b.core.settings.showThumbs===!0&&a.inArray(e.type,c)>=0&&(j="class='thumb'",k=b.core.api()+"?action=thumb&href="+e.absHref+"&width=16&height=16&mode=square",l=b.core.api()+"?action=thumb&href="+e.absHref+"&width=96&height=46&mode=rational"),h=a("<span class='label'>"+e.label+"</span>"),g=a("<a />").attr("href",e.absHref).click(function(){d(e,"extended")}).appendTo(f).append(a("<span class='icon small'><img "+j+" src='"+k+"' alt='"+e.type+"' /></span>")).append(a("<span class='icon big'><img "+j+" src='"+l+"' alt='"+e.type+"' /></span>")).append(h).append(a("<span class='date' data-time='"+e.time+"'></span>")).append(a("<span class='size' data-bytes='"+e.size+"'></span>")),g.hover(function(){if(a("#extended").hasClass("icons-view")){var b=a(this);a(".status.default").hide(),a(".status.dynamic").empty().append(b.find(".label").clone()).append(a("<span class='sep'>路</span>")).append(b.find(".date").clone()).show(),b.closest(".entry").hasClass("folder")||a(".status.dynamic").append(a("<span class='sep'>路</span>")).append(b.find(".size").clone())}},function(){a(".status.default").show(),a(".status.dynamic").empty().hide()}),e.isParentFolder&&(b.core.settings.setParentFolderLabels||h.addClass("l10n-parentDirectory"),f.addClass("folder-parent")),isNaN(e.status)||(e.status===200?(f.addClass("page"),g.find(".icon.small img").attr("src",b.core.icon("folder-page")),g.find(".icon.big img").attr("src",b.core.icon("folder-page",!0))):(f.addClass("error"),h.append(a("<span class='hint'> "+e.status+" </span>")))),e.html.$extended&&(e.html.$extended.replaceWith(f),b.core.formatDates()),e.html.$extended=f,f)},g=function(c){var e,f,h,i,j,k;e=a("<div class='entry' />").data("path",c).addClass(c.isFolder?"folder":"file"),f=a("<span class='blank' />").appendTo(e),h=a("<a />").attr("href",c.absHref).click(function(){d(c,"tree")}).appendTo(e).append(a("<span class='icon'><img src='"+b.core.icon(c.type)+"' /></span>")).append(a("<span class='label'>"+c.label+"</span>"));if(c.isFolder){if(c.status===undefined||!c.isEmpty())i=a("<span class='indicator initiated'><img src='"+b.core.image("tree")+"' /></span>").click(function(d){var e=i.closest(".entry");i.hasClass("unknown")?b.connector.fetchStatusAndContent(c.absHref,!1,function(b,d){c.status=b,c.content=d,c.treeOpen=!0,a("#tree").get(0).updateScrollbar(!0),g(c),a("#tree").get(0).updateScrollbar()}):i.hasClass("open")?(c.treeOpen=!1,i.removeClass("open"),a("#tree").get(0).updateScrollbar(!0),e.find("> ul.content").slideUp(function(){a("#tree").get(0).updateScrollbar()})):(c.treeOpen=!0,i.addClass("open"),a("#tree").get(0).updateScrollbar(!0),e.find("> ul.content").slideDown(function(){a("#tree").get(0).updateScrollbar()}))}),c.status===undefined?i.addClass("unknown"):c.treeOpen&&i.addClass("open"),f.replaceWith(i);c.isDomain&&(e.addClass("domain"),h.find(".icon img").attr("src",b.core.icon("folder-home"))),c.isCurrentFolder&&(e.addClass("current"),h.find(".icon img").attr("src",b.core.icon("folder-open"))),c.isEmpty()||(j=a("<ul class='content' />").appendTo(e),a.each(c.content,function(b,c){a("<li />").append(g(c)).appendTo(j)}),(c.status===undefined||!c.treeOpen)&&j.hide()),isNaN(c.status)||(c.status===200?(h.find(".icon img").attr("src",b.core.icon("folder-page")),h.append(a("<span class='hint'><img src='"+b.core.image("page")+"' /></span>"))):(e.addClass("error"),h.append(a("<span class='hint'>"+c.status+"</span>"))))}return c.html.$tree&&c.html.$tree.replaceWith(e),c.html.$tree=e,e},h=function(a){e(a),f(a),g(a)};return{updateCrumbHtml:e,updateExtendedHtml:f,updateTreeHtml:g,updateHtml:h}}()}(jQuery,b),function(a,b,c){c.extended=function(){var d=function(){var d=b("body > nav ul"),e="/",f=c.connector.getPath(e),g=a.location.pathname.split("/"),h="",i=a.domain;d.append(c.html.updateCrumbHtml(f)),b.each(g,function(a,b){b!==""&&(e+=b+"/",d.append(c.html.updateCrumbHtml(c.connector.getPath(e))),h=b+" - ",i+=" > "+b)}),a.title=c.util.checkedDecodeUri(h+i)},e=function(){var d,e;d=b("<ul/>"),e=b("<li class='header' />").appendTo(d).append(b("<a class='icon'></a>")).append(b("<a class='label' href='#'><span class='l10n-name'></span></a>")).append(b("<a class='date' href='#'><span class='l10n-lastModified'></span></a>")).append(b("<a class='size' href='#'><span class='l10n-size'></span></a>")),b("#table td").closest("tr").each(function(){var b=c.connector.getPath(a.location.pathname,this);d.append(c.html.updateExtendedHtml(b))}),b("#extended").append(d),d.children(".entry:not(.folder-parent)").size()===0&&b("#extended").append(b("<div class='empty l10n-empty'>empty</div>"))},f=function(){b.ajax({url:c.core.settings.customHeader,dataType:"html",success:function(a){b("#content > header").append(b(a)).show()}}),b.ajax({url:c.core.settings.customFooter,dataType:"html",success:function(a){b("#content > footer").prepend(b(a)).show()}})},g=function(a,b){c.connector.fetchStatusAndContent(a,!1,function(d,e){var f=c.connector.getPath(a);f.status=d,f.content=e,b(f)})},h=function(a,b,d){g(a,function(e){var f=c.util.splitPath(a).parent;e.treeOpen=!0,d&&(e.content[d.absHref]=d),f===null?b(e):h(f,b,e)})},i=function(){h(a.location.pathname,function(a){b("#tree").append(c.html.updateTreeHtml(a)).scrollpanel().show(),c.core.shiftTree(!1,!0),c.core.linkHoverStates(),setTimeout(function(){b("#tree").get(0).updateScrollbar()},1)})},j=function(){d(),e(),f(),c.connector.updatePaths(),c.core.settings.showTree&&i()};return{init:j}}()}(document,jQuery,b),a(function(){b.extended.init(),b.core.init(),b.sort.init(),b.zippedDownload.init()})})(jQuery)